# 歸檔節點搭建流程

**注意：**
* 準備 一台 ubuntu 主機
* 安裝 4tb 的 SSD 並透過 zfs 合併
* 需要 安裝 / 設定 zfs
* 需要 安裝 mytonctrl

## 修改 ubuntu 系統參數
> * ton 歸檔節點在運作的時候，會同時開啟多個區塊鏈資料夾，因此需要調整系統資料夾參數
> * https://www.tecmint.com/increase-set-open-file-limits-in-linux/


查看 ubuntu 系統當前的資料夾參數
```
ulimit -Hn
ulimit -Sn
```

編輯文件 `sudo nano /etc/security/limits.conf`
```
// 在 limits.conf 文件中添加 並儲存
*               soft    nofile            500000
```

重新啟動 ubuntu 主機

檢查是否生效
```
ulimit -Hn
ulimit -Sn
```

## 處理 格式化 新的 SSD
* 關機狀態 安裝完成 預計要安裝的 SSD 
* 開機 進入到 ubuntu 系統
* 進入到 系統 硬碟 設定 會看到 新的未使用的 SSD
  > 進行以下設定：格式化 切勿使用 ex4  格式 ，因為 zfs系統會完全讀不到，要點擊設定成 other —> no file system
* 開機記得自動掛載
* 重新開機

## 安裝 ZFS
> * [http://manpages.ubuntu.com/manpages/impish/man8/zpool-add.8.html](http://manpages.ubuntu.com/manpages/impish/man8/zpool-add.8.html)
> * [https://linux.cn/article-9346-1.html](https://linux.cn/article-9346-1.html)


安裝 ZFS 套件
```
sudo apt install zfsutils-linux -y
```

## 透過 ZFS 處理新的 SSD

查看當前電腦有哪些硬碟空間可以使用
```
sudo fdisk -l
```

創建新的ZFS池子
```
sudo zpool create data /dev/sdb  /dev/sdc
// 池子的名稱 = data
// 掛載硬碟 = /dev/sdb
// 掛載硬碟 = /dev/sdc
```

設定一下 ZFS 池子的壓縮格式
```
sudo zfs set compression=lz4 data
```

在 ZFS 池子 創建資料夾
```
sudo zfs create data/ton-work
```

顯示一下 ZFS 池子的狀態 
```
zpool list
```

## 安裝 mytonctrl

```
wget https://raw.githubusercontent.com/ton-blockchain/mytonctrl/master/scripts/install.sh
sudo bash install.sh -m full
```

## 下載 瑞士人的ton 節點快照

停用 ton 驗證人 節點
```
systemctl stop validator
```

備份原有的金鑰
```
sudo mv /var/ton-work /var/ton-work.bak
```

同步 快照的 相依壓縮 套件
```
sudo apt-get install pv plzip -y
sudo apt-get install screen -y
```

檢查預計下載快照的檔案名稱 http://anode2.ton.swisscops.com/dumps/

同步快照的命令 範例
```
curl -u <username>:<password> -s http://anode2.ton.swisscops.com/dumps/<link_for_last_dump> | pv | plzip -d -n 8 | zfs recv data/ton-work
```

同步快照的命令 實例
```
sudo su // 如果不用 su 會有權限問題
screen // 預防ssh 連線不穩定
curl -C - -u tonadmin:RuipDour -s http://anode2.ton.swisscops.com/dumps/ton_archival_node-13_03_2022.zfs.lz | pv | plzip -d -n 16 | zfs recv data/ton-work -F
```

同步完成之後 開始掛載 快照的數據
```
sudo zfs set mountpoint=/var/ton-work data/ton-work && zfs mount data/ton-work
```

還原 之前備份的金鑰文件
```
sudo cp -fr /var/ton-work.bak/db/config.json /var/ton-work/db/
sudo cp -fr /var/ton-work.bak/keys /var/ton-work/
sudo cp -fr /var/ton-work.bak/db/keyring /var/ton-work/db/
sudo cp -fr /var/ton-work.bak/keys/client /var/ton-work/keys/
sudo cp -fr /var/ton-work.bak/keys/client.pub /var/ton-work/keys/
sudo cp -fr /var/ton-work.bak/keys/liteserver.pub /var/ton-work/keys/
sudo cp -fr /var/ton-work.bak/keys/server.pub /var/ton-work/keys/
```

修改備份的金鑰權限
```
chown -R validator:validator /var/ton-work/db/config.json
sudo chown -R validator:validator /var/ton-work/keys
chown awesomedogewow:awesomedogewow /var/ton-work/keys/client
chown awesomedogewow:awesomedogewow /var/ton-work/keys/client.pub
chown awesomedogewow:awesomedogewow /var/ton-work/keys/liteserver.pub
chown awesomedogewow:awesomedogewow /var/ton-work/keys/server.pub
```

修改驗證人啟動參數
編輯文件 `sudo nano /etc/systemd/system/validator.service`
```
--state-ttl 315360000 --archive-ttl 315360000 --block-ttl 315360000
```

修復驗證人權限
```
chown -R validator:validator /var/ton-work
sudo chown -v validator:validator /var/ton-work
```

## 驗證人 啟動/ 關閉/ 重啟
重新 讀取 設定參數
```
systemctl daemon-reload
```
```
systemctl restart mytoncore
systemctl restart validator

systemctl status mytoncore
systemctl status validator

systemctl stop mytoncore
systemctl stop validator

systemctl disable mytoncore
systemctl disable validator

systemctl enable mytoncore
systemctl enable validator
```

## log 檢查
```
```

# 參考文獻
* 